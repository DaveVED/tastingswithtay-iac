######################################################################################################
# Creats the core supporting the tastingswithtay-ui https://github.com/DaveVED/tastingswithtay-ui
#
# Using this pipeline.yaml temaplte, you will get a pipeline configuration with the following setup.
#    1. CodeBuild to Build and push the image to ECR.
#    2. CodeDeploy to deploy teh image to ECS.
#    3. CodePipeline to wrap the CICD.
#    4. All required IAM & KMS, & Monitoring configurations.
#
# NOTE,
#    - to run, you will need your GITHUB_TOKEN in a ssm parameter store called GITHUB_TOKEN.
#    - You get 2x pipelines, one for main and develop branch!
#
# The pipleline, supports a reactjs applcaiont right now, but could be support any, if the user
# change there buildspec.yml to build a different type of docker.
######################################################################################################
AWSTemplateFormatVersion: "2010-09-09"
Description: Provision CICD to deploy a ReactJS application tastingswithtay to ECS.
Parameters:
  ENV:
    Type: String
    Default: "dev"
    AllowedValues:
      - "dev"
      - "prod"
    Description: "Environment (dev, test, prod)"
  Project:
    Type: String
    Default: "myproject"
    Description: "Project name"
  Owner:
    Type: String
    Default: "DaveVED"
    Description: "GitHub repository owner"
  Repo:
    Type: String
    Default: "tastingswithtay-ui"
    Description: "GitHub repository name"
  Branch:
    Type: String
    Default: "develop"
    Description: "GitHub repository branch name"
  ECRRepo:
    Type: String
    Default: "tastingswithtay-ui"
    Description: "ECR Repo UI for docker."

Resources:
  CodeBuildProject:
    Type: AWS::CodeBuild::Project
    Properties:
      Name: !Sub "${Project}-${ENV}-ui-build"
      Artifacts:
        Type: CODEPIPELINE
      Environment:
        Type: LINUX_CONTAINER
        ComputeType: BUILD_GENERAL1_SMALL
        Image: aws/codebuild/standard:4.0
        PrivilegedMode: true
        EnvironmentVariables: # Add this section
          - Name: AWS_DEFAULT_REGION
            Value: us-east-1
          - Name: AWS_ACCOUNT_ID
            Value: !Ref AWS::AccountId
          - Name: IMAGE_REPO_NAME
            Value: !Ref ECRRepo
      Source:
        Type: CODEPIPELINE
        BuildSpec: "buildspec.yml"
      ServiceRole: !GetAtt CodeBuildServiceRole.Arn
      Tags:
        - Key: "Name"
          Value: !Sub "${Project}-${ENV}-ui-build"
  CodeBuildServiceRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service:
                - codebuild.amazonaws.com
            Action: sts:AssumeRole
      Policies:
        - PolicyName: CodeBuildPolicy
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - logs:*
                  - s3:*
                  - ecr:*
                  - kms:*
                Resource: "*"
  CodePipeline:
    Type: AWS::CodePipeline::Pipeline
    Properties:
      Name: !Sub "${Project}-${ENV}-ui-pipeline"
      RoleArn: !GetAtt CodePipelineRole.Arn
      ArtifactStore:
        Type: S3
        Location: !Ref CodePipelineBucket
      Stages:
        - Name: Source
          Actions:
            - Name: GitHubSource
              ActionTypeId:
                Category: Source
                Owner: ThirdParty
                Provider: GitHub
                Version: 1
              OutputArtifacts:
                - Name: SourceOutput
              Configuration:
                Owner: !Ref Owner
                Repo: !Ref Repo
                Branch: !Ref Branch
                OAuthToken: "{{resolve:ssm:GITHUB_TOKEN}}"
              RunOrder: 1
        - Name: Build
          Actions:
            - Name: CodeBuild
              ActionTypeId:
                Category: Build
                Owner: AWS
                Provider: CodeBuild
                Version: 1
              InputArtifacts:
                - Name: SourceOutput
              OutputArtifacts:
                - Name: BuildOutput
              Configuration:
                ProjectName: !Ref CodeBuildProject
              RunOrder: 1
        - Name: Deploy
          Actions:
            - Name: Deploy
              ActionTypeId:
                Category: Deploy
                Owner: AWS
                Provider: CodeDeployToECS
                Version: 1
              InputArtifacts:
                - Name: BuildOutput
              Configuration:
                ApplicationName: !Ref CodeDeployApplication
                DeploymentGroupName: !Ref CodeDeployDeploymentGroup
              RunOrder: 1

      Tags:
        - Key: "Name"
          Value: !Sub "${Project}-${ENV}-ui-pipeline"
  CodePipelineRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service:
                - codepipeline.amazonaws.com
            Action: sts:AssumeRole
      Policies:
        - PolicyName: CodePipelinePolicy
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - codebuild:*
                  - codepipeline:*
                  - s3:*
                  - ecr:*
                  - iam:PassRole
                Resource: "*"
  CodePipelineBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub "${Project}-${ENV}-ui-pipeline-artifacts"
      Tags:
        - Key: "Name"
          Value: !Sub "${Project}-${ENV}-ui-pipeline-artifacts"
  CodeDeployApplication:
    Type: AWS::CodeDeploy::Application
    Properties:
      ComputePlatform: "ECS"
  CodeDeployDeploymentGroup:
    Type: AWS::CodeDeploy::DeploymentGroup
    Properties:
      ApplicationName: !Ref CodeDeployApplication
      DeploymentConfigName: "CodeDeployDefault.ECSAllAtOnce"
      DeploymentGroupName: !Sub "${Project}-${ENV}-ui-deployment-group"
      ServiceRoleArn: !GetAtt CodeDeployServiceRole.Arn
      DeploymentStyle:
        DeploymentType: "BLUE_GREEN"
        DeploymentOption: "WITH_TRAFFIC_CONTROL"
      BlueGreenDeploymentConfiguration:
        DeploymentReadyOption:
          ActionOnTimeout: "CONTINUE_DEPLOYMENT"
        TerminateBlueInstancesOnDeploymentSuccess:
          Action: "TERMINATE"
          TerminationWaitTimeInMinutes: 5
      ECSServices:
        - ServiceName: !Sub "${Project}-${ENV}-service"
          ClusterName: !Sub "${Project}-${ENV}-cluster"
  CodeDeployServiceRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service:
                - "codedeploy.amazonaws.com"
            Action: "sts:AssumeRole"
      Policies:
        - PolicyName: CodeDeployServiceRolePolicy
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - "ecs:DescribeServices"
                  - "ecs:CreateTaskSet"
                  - "ecs:UpdateServicePrimaryTaskSet"
                  - "ecs:DeleteTaskSet"
                  - "elasticloadbalancing:DescribeLoadBalancers"
                  - "elasticloadbalancing:DescribeTargetGroups"
                  - "elasticloadbalancing:DescribeListeners"
                  - "elasticloadbalancing:ModifyListener"
                  - "elasticloadbalancing:ModifyRule"
                Resource: "*"
